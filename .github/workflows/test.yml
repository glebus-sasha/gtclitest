name: Nextflow CI

on:
  push:
  pull_request:

jobs:
  test-apptainer:
    name: Test with Apptainer
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          java-version: '11'

      - name: Install Nextflow
        run: |
          curl -s https://get.nextflow.io | bash
          sudo mv nextflow /usr/local/bin/

      - name: Install Apptainer
        run: |
          sudo apt-get update && sudo apt-get install -y \
            build-essential \
            libseccomp-dev \
            pkg-config \
            squashfs-tools \
            cryptsetup \
            fuse-overlayfs \
            uidmap \
            git \
            wget \
            gnupg \
            fakeroot \
            fuse3
          wget https://github.com/apptainer/apptainer/releases/download/v1.3.0/apptainer_1.3.0_amd64.deb
          sudo dpkg -i apptainer_1.3.0_amd64.deb

      - name: Run Nextflow with apptainer
        run: nextflow run main.nf -profile apptainer

  test-docker:
    name: Test with Docker
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          java-version: '11'

      - name: Install Nextflow
        run: |
          curl -s https://get.nextflow.io | bash
          sudo mv nextflow /usr/local/bin/

      - name: Run Nextflow with docker
        run: nextflow run main.nf -profile docker
